{% extends "base.html" %}
{% load static %}
{% block title %}T·∫°o cu·ªôc thi{% endblock %}
<!doctype html>
<html lang="vi">

{% block head_extra %}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root {
        --bg: #0f172a;
        --card: #111827;

        --txt: #e5e7eb;
        --brand: #f59e0b;
        --muted: #cbd5e1;
    }

    body {
        margin: 0;
        background: var(--bg);
        color: var(--txt);
        font-family: system-ui, Segoe UI, Roboto, Inter, Arial
    }

    .container {
        max-width: 1000px;
        margin: 24px auto;
        padding: 0 16px
    }

    h1 {
        font-size: 24px;
        margin: 0 0 16px
    }

    .grid {
        display: grid;
        gap: 16px
    }

    /* Liquid glass card */
    .card {
    position: relative;
    border-radius: 16px;
    padding: 16px;
    /* l·ªõp k√≠nh trong su·ªët m·ªù */
    background: linear-gradient( to bottom right, rgba(255,255,255,0.1), rgba(255,255,255,0.06) );
    border: 1px solid rgba(255,255,255,0.14);
    box-shadow:
        0 10px 30px rgba(0,0,0,0.35),
        inset 0 1px 0 rgba(255,255,255,0.08);

    /* hi·ªáu ·ª©ng blur k√≠nh */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    }

    /* vi·ªÅn highlight m·ªÅm ·ªü m√©p tr√™n ƒë·ªÉ ‚Äú∆∞·ªõt‚Äù h∆°n */
    .card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    background:
        radial-gradient(120% 120% at -10% -20%, rgba(255,255,255,0.20), transparent 45%),
        radial-gradient(110% 110% at 120% -10%, rgba(255,255,255,0.12), transparent 45%);
    /* kh√¥ng che n·ªôi dung, ch·ªâ t·∫°o √°nh s√°ng nh·∫π */
    mix-blend-mode: screen;
    opacity: .7;
    }


    .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap
    }

    .row input,
    .row select {
        background: #0b122072;
        color: var(--txt);
        border: 1px solid #243045;
        border-radius: 8px;
        padding: 8px 10px;
        outline: none
    }

    .row select:hover,
    .row input:hover {
    border-color: #3b4a6a;
    }

    .row select:focus,
    .row input:focus {
    border-color: #6ea8ff;
    box-shadow: 0 0 0 3px rgba(110,168,255,0.25);
    }
    
    .row input::placeholder {
        color: rgba(229,231,235,0.70);   
    }

    .row input:disabled,
    .row select:disabled {
        opacity: .75;
    }

    .row label {
        font-size: 14px;
        color: var(--muted)
    }

    .btn {
      background: #f4f1ecc6;
      color: #223382;
      border: none;
      border-radius: 14px;
      padding: 5px 10px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      font-size: 13px;

      -webkit-backdrop-filter: blur(8px) saturate(130%);
      backdrop-filter: blur(8px) saturate(130%);
      box-shadow:
        0 12px 24px rgba(173, 188, 244, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }
    /* N√∫t icon: cao nh∆∞ .btn v√† canh gi·ªØa theo tr·ª•c d·ªçc */
    .btn-icon{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 7px 14px;   /* gi·ªëng .btn ƒë·ªÉ cao ngang nhau */
    line-height: 1;      /* tr√°nh k√©o d√£n chi·ªÅu cao */
    vertical-align: middle;
    }
    .btn::after {
      /* highlight g·ª£n k√≠nh */
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(120% 80% at 30% -10%,
        rgba(255,255,255,0.45), rgba(255,255,255,0.0) 45%);
      pointer-events: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 16px 30px rgba(212, 192, 249, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    .btn:active { transform: translateY(0); }

    .muted {
        color: var(--muted);
        font-size: 13px
    }

    .ct {
        border-left: 4px solid var(--brand);
        padding-left: 12px;
        margin: 8px 0
    }

    .vt {
        margin: 8px 0 8px 12px;
        border-left: 3px solid #334155;
        padding-left: 12px
    }

    .bt {
        margin: 6px 0 6px 24px;
        border-left: 2px dashed #334155;
        padding-left: 12px
    }

    .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        padding: 2px 6px;
        border-radius: 6px
    }

    .status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px
    }

    .on {
        background: #065f46
    }

    .off {
        background: #4b5563
    }

    .sec-title {
        font-size: 16px;
        margin: 0 0 8px;
        font-weight: 700
    }

    .hr {
        height: 1px;
        background: #1f2937;
        margin: 12px 0
    }

    .msg {
        margin: 0 0 8px
    }

    /* Toggle switch */
    .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 26px;
        vertical-align: middle;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: #374151;
        border-radius: 999px;
        transition: background .2s ease;
    }

    .slider:before {
        content: "";
        position: absolute;
        height: 20px;
        width: 20px;
        left: 3px;
        top: 3px;
        background: white;
        border-radius: 50%;
        transition: transform .2s ease;
    }

    .switch input:checked+.slider {
        background: #10b981;
    }

    .switch input:checked+.slider:before {
        transform: translateX(20px);
    }
    /* ------- Zebra table for modal config view ------- */
    #tplv-content table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 14px;
        overflow: hidden;          /* clip n·ªÅn c√°c h√†ng theo radius */
        border: 1px solid #334155; /* vi·ªÅn nh·∫π */
        table-layout: fixed;       /* force equal-width columns */
    }

    /* ===== Judge modal table: force consistent column alignment ===== */
    #judgev-content table {
        width: 100%;
        border-collapse: collapse; 
        table-layout: fixed; 
    }
    #judgev-content thead th,
    #judgev-content tbody td {
        padding: 8px 12px; /* reduced padding so table fits narrower modal */
        vertical-align: middle;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #judgev-content td:first-child, #judgev-content thead th:first-child {
        text-align: center;
    }
    #judgev-content td:nth-child(2), #judgev-content thead th:nth-child(2) {
        text-align: left; /* code column aligned left but narrow */
        font-weight: 600;
    }
    #judgev-content td:nth-child(3), #judgev-content thead th:nth-child(3) {
        text-align: left; /* name column expands */
    }
    #judgev-content td input[type="checkbox"] {
        margin: 0; /* remove default checkbox offset */
        vertical-align: middle;
        width: 18px;
        height: 18px;
        accent-color: #fdfbf8;
        border-radius: 4px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    #judgev-content td input[type="checkbox"]:checked {
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
    }
    #judgev-content thead th { font-weight: 700; }


    #tplv-content thead th {   
        background: #0b1220;        /* ƒë·∫ßu b·∫£ng ƒë·∫≠m h∆°n */
        color: #e5e7eb;
        border-bottom: 1px solid #334155;
        padding: 8px 10px;
        position: sticky; top: 0; z-index: 1; /* c·ªë ƒë·ªãnh header khi n·ªôi dung d√†i */
    }

    /* make columns evenly distributed in tpl view */
    #tplv-content thead th,
    #tplv-content tbody td { width: 33%; }

    #tplv-content tbody tr:nth-child(odd) {
    background: rgba(255,255,255,0.12);   /* h√†ng 1,3,5... ƒë·∫≠m h∆°n */
    }

    #tplv-content tbody tr:nth-child(even) {
    background: rgba(255,255,255,0.06);   /* h√†ng 2,4,6... nh·∫°t h∆°n */
    }

    #tplv-content tbody tr:hover {
    background: rgba(255,255,255,0.18);   /* hover n·ªïi h∆°n */
    }

    #tplv-content td {
    padding: 8px 10px;
    border-bottom: 1px solid #1f2937;
    }

    /* ===== CƒÉn gi·ªØa & gi√£n c√°ch ƒë·ªÅu trong modal th·ªùi gian ===== */
    #time-modal .tm-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto; /* 3 c·ª•m ƒë·ªÅu nhau */
    align-items: center;                /* cƒÉn gi·ªØa theo tr·ª•c d·ªçc */
    column-gap: 24px;
    row-gap: 8px;
    padding: 4px 0;
    }

    #time-modal .tm-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    padding: 0 26px;
    }

    #time-modal .tm-label,
    #time-modal .tm-unit {
    font-size: 14px;
    color: #e5e7eb;
    line-height: 1;
    }

    #time-modal .tm-input {
    background: #0b1220;
    border: 1px solid #243045;
    border-radius: 8px;
    color: #e5e7eb;
    padding: 6px 10px;
    font-size: 14px;
    height: 36px;
    width: 72px; /* v·ª´a ƒë·ªß ƒë·ªÉ nh·∫≠p ph√∫t/gi√¢y */
    text-align: center;
    }

    #time-modal .tm-scorebox {
    justify-content: flex-start;
    gap: 10px;
    }

    #time-modal .tm-del {
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 12px;
    font-size: 13px;
    }
    /* ·∫®n n√∫t tƒÉng/gi·∫£m (spinner) trong input number c·ªßa modal th·ªùi gian */
    #time-modal input[type="number"]::-webkit-outer-spin-button,
    #time-modal input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }

    #time-modal input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
    }
    .download-link {
            color: #b1c9ef;       
            text-decoration: underline;
            cursor: pointer;
        }
        .download-link:hover {
            color: #167fef; 
        }
    /* NEW: highlight khi l·ªói */
    .is-invalid {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,.18);
    }

    /* NEW: tip l·ªói nh·ªè c·∫°nh field */
    .error-tip {
    font-size: 12px;
    color: #fca5a5;
    margin-left: 8px;
    }
    .kebab{ position:relative; display:inline-block; margin-left:8px; }
    .kebab-menu{
    position:absolute; right:0; top:calc(100% + 6px);
    background:#0b1220; border:1px solid #243045; border-radius:12px;
    min-width:220px; padding:6px; box-shadow:0 12px 28px rgba(0,0,0,.4);
    z-index:50;
    }
    .kebab-item{
    display:block; width:100%; text-align:left; padding:8px 10px;
    background:transparent; color:var(--txt); border:0; border-radius:10px;
    }
    .kebab-item:hover{ background:#182235; }
    /* ==== Modal helpers: gi·ªõi h·∫°n chi·ªÅu cao & cho n·ªôi dung cu·ªôn ==== */
    .modal-overlay {
    padding: 24px;                 /* ch·ª´a kho·∫£ng ƒë·ªÉ v·∫´n th·∫•y vi·ªÅn card */
    overflow: auto;                /* n·∫øu card v·∫´n cao, overlay cho cu·ªôn */
    display: flex; align-items: center; justify-content: center;
    }

    .vt-header-btn{
    background: rgba(15,23,42,0.85);
    border-radius:999px;
    border:1px solid #243045;
    width:28px;
    height:28px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    color:#e5e7eb;
    font-size:13px;
    box-shadow:0 8px 18px rgba(0,0,0,0.4);
    }
    .vt-header-btn:hover{
    background:rgba(31,41,55,0.95);
    }
    .vt-header-btn .vt-chevron{
    font-size:12px;
    transition:transform .2s ease;
    }
    .vt-header-btn.is-collapsed .vt-chevron{
    transform:rotate(-90deg);   /* khi thu g·ªçn th√¨ quay m≈©i t√™n sang ngang */
    }

    .modal-card {
    max-height: calc(100vh - 48px);/* card kh√¥ng cao h∆°n m√†n h√¨nh */
    width: 1200px; max-width: 96vw;
    display: flex; flex-direction: column;
    overflow: hidden;              /* ·∫©n tr√†n b√™n trong, body s·∫Ω cu·ªôn */
    }

    .modal-header { flex: 0 0 auto; }
    .modal-body   { 
    flex: 1 1 auto; 
    overflow: auto;                /* ph·∫ßn th√¢n cu·ªôn d·ªçc */
    min-height: 0;                 /* fix flex-overflow tr√™n Firefox */
    }

    /* B·∫£ng b√™n trong v√πng xem c·∫•u h√¨nh: gi·ªØ sticky header, th√¢n cu·ªôn m∆∞·ª£t */
    #tplv-content { height: 100%; }
    #tplv-content .scroll-box {
    max-height: 100%;
    overflow: auto;
    }
    /* Modal x√°c nh·∫≠n nh·ªè (d√πng chung v·ªõi competitions) */
    .modal {
        background:#020617;
        border-radius:14px;
        border:1px solid #1e293b;
        padding:16px 18px;
        width:380px;
        max-width:95vw;
        box-shadow:0 18px 45px rgba(0,0,0,.6);
    }
    .modal h4{
        margin:0 0 8px;
        font-size:16px;
        font-weight:600;
        color:#e5e7eb;
    }
    .modal p{
        margin:0 0 14px;
        font-size:14px;
        color:#cbd5e1;
        white-space:pre-line; /* ƒë·ªÉ xu·ªëng d√≤ng \n trong message */
    }
    .modal-actions{
        display:flex;
        justify-content:flex-end;
        gap:8px;
    }
    .modal-actions .btn{
        margin-left:0;
    }

    /* (tu·ª≥ ch·ªçn) c√°c modal kh√°c c≈©ng n√™n c√≥ gi·ªõi h·∫°n t∆∞∆°ng t·ª± */
    #time-modal > div,
    #tpl-modal  > div {
    max-height: calc(100vh - 48px);
    overflow: auto;
    }
    .vt-btn-clean {
    background: none;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #e5e7eb;
    opacity: 0.8;
    transition: opacity .2s ease, transform .15s ease;
    }

    .vt-btn-clean:hover {
        opacity: 1;
        transform: translateY(-1px);
    }

    .vt-btn-clean svg {
        pointer-events: none;
    }

    /* M≈©i t√™n quay khi thu g·ªçn */
    .vt-chevron-icon {
        transition: transform .2s ease;
    }

    .vt-btn-clean.is-collapsed .vt-chevron-icon {
        transform: rotate(-90deg);
    }
    /* √î ch·ª©a 2 n√∫t ‚Äî ki·ªÉu gi·ªëng textfield */
.vt-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 10px;

    /* Gi·ªëng input c·ªßa b·∫°n */
    background: #0b122072;
    border: 1px solid #243045;

    /* Blur k√≠nh */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);

    /* B√≥ng ƒë·ªï nh·∫π gi·ªëng input */
    box-shadow:
        0 2px 5px rgba(0,0,0,0.25),
        inset 0 1px 0 rgba(255,255,255,0.06);
    }

    /* N√∫t icon b√™n trong container */
    .vt-icon-btn {
        background: none;
        border: none;
        padding: 2px 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #e5e7eb;
        opacity: 0.8;
        transition: opacity .2s ease, transform .1s ease;
    }

    .vt-icon-btn:hover {
        opacity: 1;
        transform: translateY(-1px);
    }

    .vt-icon-btn svg {
        pointer-events: none;
    }

    /* Icon m≈©i t√™n quay */
    .vt-icon-btn.is-collapsed .vt-chevron-icon {
        transform: rotate(-90deg);
    }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div style="margin:6px 0; margin-top: 50px;">
            <a href="/organize/competitions/" style="color:#edf0f3;text-decoration:none">‚Üê Trang Danh s√°ch cu·ªôc thi</a>
        </div>

        {% if messages %}
        <div style="margin:10px 0">
            {% for m in messages %}
            <div style="margin:6px 0; padding:8px 10px; border-radius:8px; background:#064e3b; color:#d1fae5;">
                {{ m }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="grid">

            <!-- Danh s√°ch Cu·ªôc thi -->
            <div class="card">
                <div class="sec-title">Danh s√°ch cu·ªôc thi</div>
                <div class="muted">Nh·∫•n ‚ÄúTh√™m v√≤ng thi‚Äù / ‚ÄúTh√™m b√†i thi‚Äù ƒë·ªÉ b·ªï sung nhanh.</div>
                <div class="hr"></div>

                {% for ct in cuoc_this %}
                <div class="ct">
                    <div>
                        &nbsp;{{ ct.tenCuocThi }}
                        &nbsp;<span class="status {{ ct.trangThai|yesno:'on,off' }}">
                            {{ ct.trangThai|yesno:"ƒêang b·∫≠t,ƒêang t·∫Øt" }}
                        </span>

                        <!-- N√∫t tr∆∞·ª£t b·∫≠t/t·∫Øt ngay b√™n c·∫°nh -->
                        <form method="post" style="display:inline-block; margin-left:8px">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_ct">
                            <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                            <label class="switch" title="B·∫≠t/t·∫Øt cu·ªôc thi">
                                <input type="checkbox" name="trangThai" {% if ct.trangThai %}checked{% endif %}
                                    onchange="this.form.submit()">
                                <span class="slider"></span>
                            </label>
                        </form>


                    </div>

                    <!-- Form th√™m V√≤ng thi cho Cu·ªôc thi n√†y -->
                    <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_vt">
                        <input type="hidden" name="cuocThi_id" value="{{ ct.id }}">
                        <label>Th√™m v√≤ng thi</label>
                        <input type="text" name="tenVongThi" placeholder="VD: V√≤ng lo·∫°i" required>
                        <button class="btn" type="submit">Th√™m v√≤ng</button>
                    </form>

{% for vt in ct.vong_thi.all %}
    <div class="vt">

        <!-- HEADER V√íNG THI: t√™n = input + n√∫t L∆∞u + n√∫t x√≥a/thu g·ªçn -->
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">

<!-- Form ƒë·ªïi t√™n v√≤ng thi (auto-popup, kh√¥ng c·∫ßn n√∫t L∆∞u) -->
<form method="post"
      class="js-rename-vt-form"
      style="display:flex; align-items:center; gap:8px; margin:0;">
    {% csrf_token %}
    <input type="hidden" name="action" value="rename_vt">
    <input type="hidden" name="vongThi_id" value="{{ vt.id }}">

    <input type="text"
           name="tenVongThi"
           value="{{ vt.tenVongThi }}"
           data-init="{{ vt.tenVongThi|escapejs }}"
           style="background:#0b122072;
                  color:#e5e7eb;
                  border:1px solid #243045;
                  border-radius:8px;
                  padding:6px 10px;
                  min-width:220px;
                  font-weight:600;">
</form>


            <!-- √î ch·ª©a 2 n√∫t icon (x√≥a / ·∫©n-hi·ªán) gi·ªØ nguy√™n ƒë·ªÉ JS d√πng -->
            <div class="vt-controls">
                <!-- X√≥a v√≤ng thi -->
                <button type="button"
                        class="vt-icon-btn"
                        title="X√≥a v√≤ng thi"
                        data-delete-vt
                        data-vtid="{{ vt.id }}"
                        data-vtname="{{ vt.tenVongThi }}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>

                <!-- ·∫®n / hi·ªán -->
                <button type="button"
                        class="vt-icon-btn"
                        title="·∫®n/hi·ªán v√≤ng thi"
                        data-vt-toggle="{{ vt.id }}">
                    <svg class="vt-chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- BODY V√íNG THI GI·ªÆ NGUY√äN -->
        <div class="vt-body" data-vt-body="{{ vt.id }}" style="margin-top:8px;">

                                <!-- Form th√™m B√†i thi cho V√≤ng n√†y -->
                                <form method="post" class="row" style="margin-top:8px;align-items:center;gap:10px">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="create_bt">
                                    <input type="hidden" name="vongThi_id" value="{{ vt.id }}">

                                    <div class="card add-bt"
                                        style="position:relative; display:grid; grid-template-columns:1fr; gap:10px;
                                                margin-bottom:8px; margin: 8px 0 8px; width: calc(100% - 24px);">

                                        <!-- H√†ng ch√≠nh chia l√†m 2 c·ªôt: tr√°i & ph·∫£i -->
                                        <div class="row" style="
                                                display: flex;
                                                justify-content: flex-start;
                                                align-items: flex-start;
                                                gap: 100px;
                                                flex-wrap: wrap;
                                            ">

                                            <!-- C·ªôt tr√°i: Th√™m b√†i thi + Gi√°m kh·∫£o -->
                                            <div style="display: flex; flex-direction: column; gap: 12px; min-width: 280px;">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <label>Th√™m b√†i thi</label>
                                                    <input type="text" name="tenBaiThi" placeholder="VD: L√Ω thuy·∫øt" required
                                                        style="min-width: 225px;">
                                                </div>

                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <label>Gi√°m kh·∫£o ch·∫•m</label>
                                                    <select name="judge_id" style="min-width: 180px;">
                                                        <option value="">‚Äî Ch·ªçn gi√°m kh·∫£o ‚Äî</option>
                                                        {% for gk in judges %}
                                                        <option value="{{ gk.maNV }}">{{ gk.hoTen }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- C·ªôt ph·∫£i: Ph∆∞∆°ng th·ª©c ch·∫•m + c·∫•u h√¨nh -->
                                            <div style="display: flex; flex-direction: column; gap: 12px; min-width: 280px;">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <label>Ph∆∞∆°ng th·ª©c ch·∫•m</label>
                                                    <select name="phuongThucCham" class="js-method" style="min-width: 220px;">
                                                        <option value="TIME">Ch·∫•m theo th·ªùi gian</option>
                                                        <option value="TEMPLATE">Ch·∫•m theo m·∫´u</option>
                                                        <option value="POINTS" selected>Ch·∫•m theo thang ƒëi·ªÉm</option>
                                                    </select>
                                                </div>

                                                <div class="js-method-extra"
                                                    style="display: flex; align-items: center; gap: 10px;">
                                                    <label class="js-max-label" style="display:none;">ƒêi·ªÉm t·ªëi ƒëa</label>
                                                    <input class="js-max-input" type="number" name="cachChamDiem" min="1" step="1"
                                                        placeholder="VD: 10"
                                                        style="display:none; width:100px;">
                                                    <label class="js-file-template" style="display:none;">
                                                        M·∫´u ch·∫•m thi:
                                                        <a class="download-link"
                                                        href="{% static 'files/m·∫´u ch·∫•m thi.xlsx' %}"
                                                        download>file_m·∫´u_th√≠_sinh.xlsx</a>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- N√∫t ·ªü g√≥c ph·∫£i d∆∞·ªõi -->
                                        <button class="btn" type="submit"
                                                style="position:absolute; right:12px; bottom:12px;">
                                            Th√™m b√†i
                                        </button>
                                    </div>
                                </form>

                                {% for bt in vt.bai_thi.all %}
                                <div class="bt">
                                    <div>
                                        {{ bt.tenBaiThi }}

                                        {% if bt.phuongThucCham == "POINTS" %}
                                        ‚Äî Thang ƒëi·ªÉm (Max: {{ bt.cachChamDiem }})

                                        <div class="kebab" data-menu-btid="{{ bt.id }}">
                                            <button class="btn btn-icon kebab-toggle" type="button" aria-label="M·ªü menu">
                                                <img src="{% static 'pics/more.png' %}" alt="menu" width="18" height="18"
                                                    style="display:block;pointer-events:none">
                                            </button>
                                            <div class="kebab-menu" style="display:none">
                                                <button class="kebab-item" type="button"
                                                        data-open-judge-view
                                                        data-btid="{{ bt.id }}">
                                                    Xem gi√°m kh·∫£o ch·∫•m
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-delete-bt
                                                        data-btid="{{ bt.id }}"
                                                        data-btname="{{ bt.tenBaiThi }}">
                                                    X√≥a b√†i thi
                                                </button>
                                            </div>
                                        </div>

                                        <div id="tplview-{{ bt.id }}" style="display:none">
                                            <div style="margin-bottom:8px">
                                                {{ vt.tenVongThi }} &nbsp;‚Ä¢&nbsp; {{ bt.tenBaiThi }}
                                            </div>
                                            <div style="font-size:14px">
                                                ƒêi·ªÉm t·ªëi ƒëa: <strong>{{ bt.cachChamDiem }}</strong>
                                            </div>
                                        </div>

                                        {% elif bt.phuongThucCham == "TIME" %}
                                        ‚Äî Theo th·ªùi gian

                                        <div class="kebab" data-menu-btid="{{ bt.id }}">
                                            <button class="btn btn-icon kebab-toggle" type="button" aria-label="M·ªü menu">
                                                <img src="{% static 'pics/more.png' %}" alt="menu" width="18" height="18"
                                                    style="display:block;pointer-events:none">
                                            </button>
                                            <div class="kebab-menu" style="display:none">
                                                <!-- <button class="kebab-item" type="button"
                                                        data-open-tpl-view
                                                        data-target="tplview-{{ bt.id }}">
                                                    Xem c·∫•u h√¨nh
                                                </button> -->
                                                <button class="kebab-item" type="button"
                                                        data-open-time-modal
                                                        data-btid="{{ bt.id }}"
                                                        data-rules='[{% for r in bt.time_rules.all %}
                                                            {"start":{{ r.start_seconds }},"end":{{ r.end_seconds }},"score":{{ r.score }}}
                                                            {% if not forloop.last %},{% endif %}
                                                        {% endfor %}]'>
                                                    C·∫•u h√¨nh thang th·ªùi gian
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-open-judge-view
                                                        data-btid="{{ bt.id }}">
                                                    Xem gi√°m kh·∫£o ch·∫•m
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-delete-bt
                                                        data-btid="{{ bt.id }}"
                                                        data-btname="{{ bt.tenBaiThi }}">
                                                    X√≥a b√†i thi
                                                </button>
                                            </div>
                                        </div>

                                        <div id="tplview-{{ bt.id }}" style="display:none">
                                            <div style="margin-bottom:8px">
                                                {{ vt.tenVongThi }} &nbsp;‚Ä¢&nbsp; {{ bt.tenBaiThi }}
                                            </div>
                                            <table class="table" style="width:100%;">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align:left; padding:6px 8px">Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                                                        <th style="text-align:left; padding:6px 8px">Th·ªùi gian k·∫øt th√∫c</th>
                                                        <th style="text-align:left; padding:6px 8px">ƒêi·ªÉm</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for r in bt.time_rules.all %}
                                                    <tr>
                                                        <td style="padding:6px 8px">{{ r.start_seconds }}</td>
                                                        <td style="padding:6px 8px">{{ r.end_seconds }}</td>
                                                        <td style="padding:6px 8px">{{ r.score }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        {% else %}
                                        ‚Äî Theo m·∫´u

                                        <div class="kebab" data-menu-btid="{{ bt.id }}">
                                            <button class="btn btn-icon kebab-toggle" type="button" aria-label="M·ªü menu">
                                                <img src="{% static 'pics/more.png' %}" alt="menu" width="18" height="18"
                                                    style="display:block;pointer-events:none">
                                            </button>
                                            <div class="kebab-menu" style="display:none">
                                                <button class="kebab-item" type="button"
                                                        data-open-tpl-view
                                                        data-target="tplview-{{ bt.id }}">
                                                    Xem c·∫•u h√¨nh ch·∫•m m·∫´u
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-open-tpl-modal
                                                        data-btid="{{ bt.id }}">
                                                    C·∫•u h√¨nh m·∫´u ch·∫•m
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-open-judge-view
                                                        data-btid="{{ bt.id }}">
                                                    Xem gi√°m kh·∫£o ch·∫•m
                                                </button>
                                                <button class="kebab-item" type="button"
                                                        data-delete-bt
                                                        data-btid="{{ bt.id }}"
                                                        data-btname="{{ bt.tenBaiThi }}">
                                                    X√≥a b√†i thi
                                                </button>
                                            </div>
                                        </div>

                                        {% if bt.template_sections.all|length %}
                                        <div id="tplview-{{ bt.id }}" style="display:none">
                                            <div style="margin-bottom:8px">
                                                {{ vt.tenVongThi }} &nbsp;‚Ä¢&nbsp; {{ bt.tenBaiThi }}
                                            </div>
                                            <table class="table" style="width:100%;">
                                                <thead>
                                                    <tr>
                                                        <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">
                                                            M·ª•c l·ªõn
                                                        </th>
                                                        <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">
                                                            M·ª•c nh·ªè
                                                        </th>
                                                        <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">
                                                            ƒêi·ªÉm/Max
                                                        </th>
                                                        <th style="text-align:center; border-bottom:1px solid #334155; padding:6px 8px">
                                                            Ghi ch√∫
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for s in bt.template_sections.all %}
                                                        {% for i in s.items.all %}
                                                            <tr>
                                                                <td style="padding:6px 8px">
                                                                    {{ s.title }}
                                                                </td>
                                                                <td style="padding:6px 8px">
                                                                    {{ i.content }}
                                                                </td>
                                                                <td style="padding:6px 8px; text-align:center">
                                                                    {% if i.max_score or i.max_score == 0 %}
                                                                        {{ i.max_score }}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td style="padding:6px 8px">
                                                                    {% if i.ghiChu %}
                                                                        {{ i.ghiChu }}
                                                                    {% elif i.note %}
                                                                        {{ i.note }}
                                                                    {% else %}
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% empty %}
                                                        <tr>
                                                            <td colspan="4" class="muted" style="padding:6px 8px">
                                                                Ch∆∞a c√≥ m·ª•c nh·ªè.
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% endif %}
                                        {% endif %}

                                        <div id="assigned-{{ bt.id }}" hidden
                                            data-assigned="{% for a in bt.assignments %}{{ a.giamKhao.maNV }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                            data-title="{{ bt.tenBaiThi|escape }}">
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="bt muted">Ch∆∞a c√≥ b√†i thi.</div>
                                {% endfor %}
                            </div> <!-- /vt-body -->
                        </div>
                        {% empty %}
                        <div class="vt muted">Ch∆∞a c√≥ v√≤ng thi.</div>
                        {% endfor %}

                </div>
                <div class="hr"></div>
                {% empty %}
                <div class="muted">Ch∆∞a c√≥ cu·ªôc thi n√†o. H√£y t·∫°o cu·ªôc thi ƒë·∫ßu ti√™n ·ªü tr√™n.</div>
                {% endfor %}
            </div>
        </div>

        <p class="muted" style="margin-top:10px">
            Tip: M√£ (CTxxx/VTxxx/BTxxx) s·∫Ω t·ª± sinh khi t·∫°o m·ªõi.
        </p>
    </div>

    <!-- MODAL c·∫•u h√¨nh th·ªùi gian -->
    <div id="time-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:1100px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">C·∫•u h√¨nh thang th·ªùi gian</div>
                <button id="tm-close" class="btn" type="button">ƒê√≥ng</button>
            </div>
            <form id="tm-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="config_time_rules">
            <input type="hidden" name="baiThi_id" id="tm-btid">
            <input type="hidden" name="time_rules_json" id="tm-json">

            <div class="row" style="margin-bottom:8px">
                <button class="btn" type="button" id="tm-add">Th√™m d√≤ng</button>
            </div>

            <div id="tm-rows" class="grid" style="gap:8px"></div>
            </form>

            <div class="row" style="margin-top:12px; justify-content:flex-end; gap:12px; align-items:center">
            <form id="tm-import-form" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center">
                {% csrf_token %}
                <input type="hidden" name="action" value="time_upload_preview">
                <input type="hidden" name="baiThi_id" id="tm-import-btid">
                <label style="white-space:nowrap">Import (Excel)</label>
                <input type="file" name="time_file" id="tm-file" accept=".xlsx"
                    style="background:#0b1220;color:#e5e7eb;border:1px solid #243045;border-radius:8px;padding:8px 10px">
                <button class="btn" type="submit">Import file</button>
            </form>
            <!-- üîΩ N√∫t T·∫£i file m·∫´u (ƒë√≠nh k√®m t·ª´ static/files) -->
            <a class="btn" href="{% static 'files/m·∫´u file ch·∫•m theo th·ªùi gian.xlsx' %}" download>
                T·∫£i file m·∫´u
            </a>
            <!-- N√∫t n√†y submit form CH√çNH nh·ªù thu·ªôc t√≠nh form="tm-form" -->
            <button class="btn" type="submit" form="tm-form">L∆∞u c·∫•u h√¨nh</button>
            </div>
        </div>
    </div>
    <!-- MODAL c·∫•u h√¨nh m·∫´u ch·∫•m -->
    <div id="tpl-modal"
        style="display:none; position:fixed; inset:0; background:#0009; z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; width:560px; max-width:95vw">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="sec-title">Import m·∫´u ch·∫•m (Excel)</div>
                <button id="tpl-close" class="btn" type="button">ƒê√≥ng</button>
            </div>

            <form id="tpl-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="config_template_upload">
                <input type="hidden" name="baiThi_id" id="tpl-btid">
                <div class="row" style="gap:10px; align-items:center">
                    <label>T·ªáp .xlsx</label>
                    <input type="file" name="template_file" id="tpl-file" accept=".xlsx" required
                        style="background:#0b1220;color:#e5e7eb;border:1px solid #243045;border-radius:8px;padding:8px 10px">
                    <button class="btn" type="submit">T·∫£i l√™n & L∆∞u</button>
                </div>
                <div class="muted" style="margin-top:8px;font-size:12px">
                    Y√™u c·∫ßu c·ªôt: <em>Section/M·ª•c l·ªõn</em>, <em>Item/M·ª•c nh·ªè</em>, <em>ƒêi·ªÉm/Max</em> (c√≥ th·ªÉ th√™m Ghi
                    ch√∫).
                </div>
            </form>
        </div>
    </div>
<!-- MODAL xem c·∫•u h√¨nh ƒë√£ th√™m -->
<div id="tpl-view-modal"
     class="modal-overlay"
     style="display:none; position:fixed; inset:0; background:#0009; z-index:1000;">
  <div class="card modal-card">
    <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="sec-title">C·∫•u h√¨nh ƒë√£ th√™m</div>
      <button id="tplv-close" class="btn btn-sm" type="button">ƒê√≥ng</button>
    </div>

    <div class="modal-body">
      <!-- gi·ªØ nguy√™n id ƒë·ªÉ JS hi·ªán n·ªôi dung -->
      <div id="tplv-content">
        <!-- b·ªçc b·∫£ng render v√†o scroll-box ƒë·ªÉ cu·ªôn -->
        <div class="scroll-box">
          <!-- b·∫£ng s·∫Ω ƒë∆∞·ª£c JS nh√©t v√†o ƒë√¢y nh∆∞ tr∆∞·ªõc -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Xem gi√°m kh·∫£o ch·∫•m -->
<div id="judge-view-modal"
     class="modal-overlay"
     style="display:none; position:fixed; inset:0; background:#0b1220cc; z-index:1000;">
  <div class="card modal-card" style="width:600px; max-width:60vw;">
    <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:8px;">
      <div id="judgev-title" class="sec-title">Gi√°m kh·∫£o ch·∫•m</div>
      <button id="judgev-close" class="btn btn-sm" type="button">ƒê√≥ng</button>
    </div>

    <div class="modal-body">
      <!-- Gi·ªõi h·∫°n ph·∫ßn n·ªôi dung ƒë·ªÉ cu·ªôn d·ªçc khi danh s√°ch d√†i -->
      <div id="judgev-content"></div>
    </div>
  </div>
</div>

<!-- MODAL X√ìA V√íNG THI -->
<div id="delete-vt-modal"
     style="display:none; position:fixed; inset:0; background:#0008; z-index:2000;
            align-items:center; justify-content:center;">
  <div style="background:#111827; padding:24px 24px 18px; border-radius:14px; width:360px;
              border:1px solid #243045;">
    <div style="font-size:18px; font-weight:600; margin-bottom:12px; text-align:center;">
      X√≥a v√≤ng thi
    </div>
    <div id="delete-vt-message"
         style="margin-bottom:24px; font-size:14px; color:#e5e7eb; text-align:center; line-height:1.5;">
      B·∫°n c√≥ mu·ªën x√≥a v√≤ng thi?
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="delete-vt-cancel"
              class="btn"
              type="button"
              style="background:#374151; color:#fff;">
        H·ªßy
      </button>
      <button id="delete-vt-ok"
              class="btn"
              type="button"
              style="background:#dc2626; color:#fff;">
        ƒê·ªìng √Ω
      </button>
    </div>
  </div>
</div>

<!-- MODAL X√ìA B√ÄI THI -->
<div id="delete-bt-modal"
     style="display:none; position:fixed; inset:0; background:#0008; z-index:2000;
            align-items:center; justify-content:center;">
  <div style="background:#111827; padding:20px; border-radius:12px; width:360px;
              border:1px solid #243045; text-align:center;">
      
    <div style="font-size:18px; font-weight:600; margin-bottom:12px;">
      X√≥a b√†i thi
    </div>

    <div id="delete-bt-message" style="margin-bottom:20px; font-size:14px; color:#e5e7eb;">
      B·∫°n c√≥ mu·ªën x√≥a b√†i thi?
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 8px;">
      <button id="delete-bt-cancel"
            class="btn"
            type="button"
            style="background:#374151; color:#fff;">
            H·ªßy
      </button>

      <button id="delete-bt-ok"
              class="btn"
              type="button"
              style="background:#dc2626; color:#fff;">
        ƒê·ªìng √Ω
      </button>
    </div>
  </div>
</div>
<!-- MODAL X√ÅC NH·∫¨N ƒê·ªîI T√äN (d√πng chung openConfirm trong organize.js) -->
<div id="confirmModal"
     class="modal-overlay"
     style="display:none; position:fixed; inset:0; background:#0008; z-index:2100;">
  <div class="modal">
    <h4>X√°c nh·∫≠n</h4>
    <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u thay ƒë·ªïi?</p>
    <div class="modal-actions">
      <button type="button"
              id="confirmCancel"
              class="btn"
              style="background:#4b5563; color:#e5e7eb;">
        H·ªßy
      </button>
      <button type="button"
              id="confirmOk"
              class="btn">
        ƒê·ªìng √Ω
      </button>
    </div>
  </div>
</div>

    {{ judges_payload|json_script:"all-judges" }}
    <script>
        window.ALL_JUDGES = JSON.parse(document.getElementById('all-judges').textContent);
    </script>

    <script src="{% static 'core/organize.js' %}?v={% now 'U' %}"></script>
{% endblock %}
